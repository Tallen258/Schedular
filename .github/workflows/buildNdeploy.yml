name: Build & Push Docker Images

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

env:
  REGISTRY: docker.io
  DH_USER: ${{ secrets.DOCKERHUB_USERNAME }}
  DH_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: client/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: ./client

      - name: Run linting
        run: pnpm lint
        working-directory: ./client

      - name: Run tests
        run: pnpm test --run
        working-directory: ./client

  build-and-push:
    runs-on: ubuntu-latest
    needs: test

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DH_USER }}
          password: ${{ env.DH_TOKEN }}
        
      - name: Build & Push CLIENT (bash)
        run: |
          docker build  \
            -f ./client/Dockerfile \
            -t ${{ env.DH_USER }}/schedular-client:${{ github.run_number }} \
            --build-arg VITE_API_URL=/api \
            ./client
          docker push ${{ env.DH_USER }}/schedular-client:${{ github.run_number }}

      - name: Build & Push SERVER (bash)
        run: |
          docker build  \
            -f ./server/Dockerfile \
            -t ${{ env.DH_USER }}/schedular-server:${{ github.run_number }} \
            ./server
          docker push ${{ env.DH_USER }}/schedular-server:${{ github.run_number }}

  deploy:
    runs-on: self-hosted
    needs: build-and-push

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Google OAuth Secret
        run: |
          kubectl create secret generic google-oauth-secret \
            --from-literal=GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
            --from-literal=GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
            --namespace=taft \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Postgres Secret
        run: |
          kubectl create secret generic postgres-secret \
            --from-literal=POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
            --from-literal=DATABASE_URL="postgresql://schedular_user:${{ secrets.POSTGRES_PASSWORD }}@postgres-svc:5432/schedular" \
            --namespace=taft \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Session Secret
        run: |
          kubectl create secret generic session-secret \
            --from-literal=SESSION_SECRET="${{ secrets.SESSION_SECRET }}" \
            --namespace=taft \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create AI Secret
        run: |
          kubectl create secret generic ai-secret \
            --from-literal=OPENWEBUI_API_KEY="${{ secrets.OPENWEBUI_API_KEY }}" \
            --namespace=taft \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply Kubernetes Changes
        run: |
          export BUILD_NUMBER=${{ github.run_number }}

          for FILE in "kubernetes"/*
          do
              # Skip secret files as they're handled separately
              if [[ "$FILE" == *"-secret.yml" ]]; then
                continue
              fi
              cat $FILE | envsubst | kubectl apply -f -
          done
            