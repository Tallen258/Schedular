services:
  db:
    image: postgres:16-alpine
    container_name: calendar-ai-db
    environment:
      - POSTGRES_USER=schedular_user
      - POSTGRES_PASSWORD=schedular_pass
      - POSTGRES_DB=schedular
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./schema.sql:/docker-entrypoint-initdb.d/schema.sql
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U schedular_user -d schedular"]
      interval: 10s
      timeout: 5s
      retries: 5

  client:
    image: node:20-alpine
    container_name: calendar-ai-client
    working_dir: /app
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=development
      - VITE_API_URL=http://localhost:3000
      - WATCHPACK_POLLING=true # Enable hot reload on Windows
    volumes:
      - ./client:/app
      - client_node_modules:/app/node_modules
    command: >
      sh -c "corepack enable &&
             pnpm config set store-dir /app/.pnpm-store &&
             pnpm install --frozen-lockfile &&
             pnpm run dev -- --host 0.0.0.0 --port 5173"
    depends_on:
      - server
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:5173"]
      interval: 10s
      timeout: 5s
      retries: 3

  server:
    image: node:20-alpine
    container_name: calendar-ai-server
    working_dir: /app
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - CORS_ALLOWED_ORIGINS=http://localhost:5173
      - DEV_ALLOW_FAKE_USER=true
      - DATABASE_URL=postgres://schedular_user:schedular_pass@db:5432/schedular
      - POST_LINK_REDIRECT=http://localhost:5173
      # Google OAuth Configuration - Set these in .env file
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI=${GOOGLE_REDIRECT_URI:-http://localhost:3000/api/auth/google/callback}
      - SESSION_SECRET=${SESSION_SECRET:-change-this-in-production}
      # Keycloak/OIDC Configuration
      - AUTH_ISSUER=${AUTH_ISSUER:-https://auth-dev.snowse.io/realms/DevRealm}
      - AUTH_AUDIENCE=${AUTH_AUDIENCE:-taft-chat-api}
      - OIDC_ISSUER=${OIDC_ISSUER:-https://auth-dev.snowse.io/realms/DevRealm}
      - OIDC_AUDIENCE=${OIDC_AUDIENCE:-taft-chat}
      # AI Configuration
      - AI_BASE_URL=${AI_BASE_URL:-https://ai-snow.reindeer-pinecone.ts.net}
      - OPENWEBUI_API_KEY=${OPENWEBUI_API_KEY}
    volumes:
      - ./server:/app
      - server_node_modules:/app/node_modules
    command: >
      sh -c "corepack enable &&
             pnpm config set store-dir /app/.pnpm-store &&
             pnpm install --frozen-lockfile &&
             pnpm run dev"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3

volumes:
  client_node_modules:
  server_node_modules:
  postgres_data:

networks:
  app-network:
    driver: bridge
